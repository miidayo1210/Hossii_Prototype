# 匿名利用機能 仕様

> 最終更新: 2026-02-24
> 関連ファイル:
> `src/core/contexts/AuthContext.tsx`
> `src/core/utils/profileStorage.ts`
> `src/components/Auth/OnboardingModal.tsx`
> `src/App.tsx`

---

## 概要

Hossii はアカウント登録なしで気持ちを投稿できることを前提に設計されている。
現在のプロトタイプでは認証システムが**モック実装**であり、
実質的にどのユーザーも匿名でアプリを利用できる状態。
ユーザーの識別はサーバーではなく**端末の localStorage** にのみ依存する。

---

## 実装ステータス

| 機能 | 状態 |
|------|------|
| ログイン UI | 実装済み（メール・Google・Facebook） |
| 実際の認証 | **未実装（モック）** |
| ユーザーID | 端末ローカルで自動生成 |
| プロフィール保存 | localStorage のみ（サーバー保存なし） |
| 投稿の本人識別 | 端末固有ID で照合 |

---

## ユーザーフロー

### 初回起動

```
アプリ起動
  │
  ├─ 未ログイン → StartScreen → LoginScreen
  │                                  │
  │                          メール入力（どんな値でも通過）
  │                                  │
  └─ ログイン済み                     ↓
        │                     OnboardingModal
        │                 ユーザーID・ニックネームを入力
        │                           │
        └─────────────── アプリ本体（PostScreen）
```

### 2回目以降の起動

- localStorage に `mock_auth_user` が残っていれば自動ログイン扱い
- OnboardingModal はスキップされる

---

## ログイン

### 対応メソッド

| メソッド | UI | 実態 |
|---------|-----|------|
| メール + パスワード | あり | パスワード検証なし。どんな値でも成功 |
| Google ログイン | あり | OAuth 未接続。固定ユーザーを返すだけ |
| Facebook ログイン | あり | OAuth 未接続。固定ユーザーを返すだけ |

### ログイン後に生成されるユーザー情報

```
uid          : "user-{timestamp}" の形式で自動生成
email        : 入力値そのまま
displayName  : メールアドレスの @ より前の文字列
```

localStorage キー: `mock_auth_user`

---

## オンボーディング

ログイン後、初回のみ表示されるプロフィール設定画面。

| 項目 | 制約 | 備考 |
|------|------|------|
| ユーザーID | 英数字 3〜20 文字・小文字に正規化 | 重複チェックは未実装 |
| ニックネーム | 1〜30 文字 | 後から変更可能 |

入力完了後、`profile_{uid}` として localStorage に保存される。

---

## プロフィールの構造

プロフィール情報は現在 **2つの異なるキー** で localStorage に保存されており、役割が分離している。

### オンボーディング由来のプロフィール

- キー: `profile_{uid}`
- 内容: `{ userId, nickname }`
- 用途: チュートリアルの既読管理に使用

### 投稿用プロフィール

- キー: `hossii.profile`
- 内容: `{ id, defaultNickname, createdAt }`
- 用途: 投稿の `authorId`・`authorName` に使用される端末固有の識別子

> 投稿の本人識別に使われるのは**認証の uid ではなく `hossii.profile.id`**（端末ごとに自動生成）。
> そのため、同じメールアドレスでログインし直しても端末が変わると別人として扱われる。

---

## 投稿における識別情報

| フィールド | 設定値 |
|-----------|--------|
| `authorId` | `hossii.profile.id`（端末固有ID） |
| `authorName` | スペース固有ニックネーム → デフォルトニックネーム → 未設定 |

- Listen モードの自動投稿は `authorId` が `undefined` になる（識別不可）
- デバイスをまたいで同一ユーザーと判定する手段は現状ない

---

## スペース招待リンクと参加

- `?space=<id>` の URL パラメータでスペースに参加できる
- モックログインさえしていれば誰でも参加可能
- 参加時にニックネーム入力モーダルが表示される
- 入力されたニックネームは `hossii.spaceNicknames` に localStorage 保存

---

## 現状の制約

| 制約 | 内容 |
|------|------|
| 認証がモック | どんな email / password でもログインできる |
| 識別が端末依存 | ブラウザ・デバイスを変えると別人になる |
| ユーザーID の重複なし | 同じ userId を複数人が使える |
| データがサーバーに保存されない | 全て localStorage のみ |
| Google / Facebook 認証が未動作 | 固定ユーザーを返すだけ |

---

## 将来の実装方針

- Supabase Auth または Firebase Auth に置き換え
- `hossii.profile.id` を認証 UID に統合する
- ユーザーID の一意性をサーバー側で検証する
- プロフィールを Supabase の `profiles` テーブルで管理する
- 匿名ログイン（Supabase Anonymous Auth）の採用も検討
