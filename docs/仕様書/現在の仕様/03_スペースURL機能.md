# スペース URL 機能 仕様

> 最終更新: 2026-03-01

---

## 概要

スペースごとの固有 URL を生成し、参加者がそのスペースに直接アクセスできるようにする機能。
URL はコミュニティ ID とスペース ID の 2 階層で構成する。

---

## 最終 URL 設計（目標）

```
/c/[community-id]/s/[space-id]/
```

| セグメント | 説明 | 編集 | バリデーション |
|-----------|------|------|--------------|
| `community-id` | コミュニティのスラッグ（例: `hossii-team`） | 管理画面から編集可 | 英小文字・数字・ハイフン、3〜40文字、先頭末尾ハイフン不可 |
| `space-id` | スペースのスラッグ（例: `abc123`） | 管理画面から編集可 | 英小文字・数字・ハイフン、3〜40文字、先頭末尾ハイフン不可 |

> 現在は `/s/[space-id]` のみ実装済み。段階的に移行する（フェーズ計画参照）。

---

## 段階的実装計画（フェーズ）

### フェーズ 1 — URL バーの修正（優先度：高）

**問題:** 入室後に URL が `/#screen` に書き換えられるため、ブラウザのアドレスバーからコピーしたリンクが使えない。

**目標:** 入室後も `/s/[space-id]` を URL バーに保持する。

```
変更前: window.history.replaceState({}, '', '/#screen')
変更後: window.history.replaceState({}, '', `/s/${spaceURL}`)
```

**対象ファイル:** `src/App.tsx`（2箇所の `replaceState`）

---

### フェーズ 2 — コミュニティ別スペース分離（優先度：高）

**問題:** 現状は全管理者が同じスペース一覧を見てしまう。

**目標:** ログインしたアカウントの `community_id` でスペースをフィルタリングする。

| 変更内容 | 対象 |
|---------|------|
| `fetchSpaces(communityId)` でフィルタリング | `src/core/utils/spacesApi.ts` |
| スペース作成時に `community_id` を付与 | `src/core/utils/spacesApi.ts` |
| `AuthContext` から `communityId` を取得して渡す | `src/core/hooks/useHossiiStore.tsx` |
| Supabase RLS: 自コミュニティのスペースのみ操作可 | Supabase ダッシュボード（SQL） |

---

### フェーズ 3 — URL 構造移行（フェーズ2完了後）

**目標:** `/s/[space-id]` → `/c/[community-id]/s/[space-id]/` へ移行する。

| 変更内容 | 対象 |
|---------|------|
| App.tsx のパスマッチ正規表現を更新 | `src/App.tsx` |
| 招待 URL コピーを新フォーマットに更新 | `src/components/SpacesScreen/SpacesScreen.tsx` |
| ShareTab の URL プレフィックスを更新 | `src/components/SpaceSettingsScreen/ShareTab.tsx` |
| QRCodePanel の URL 生成を更新 | `src/components/Navigation/QRCodePanel.tsx` |

**後方互換:** `/s/[space-id]` への旧 URL アクセス時は `/c/[community-id]/s/[space-id]/` へリダイレクトする（将来対応）。

---

### フェーズ 4 — 将来対応

- コミュニティ slug の編集 UI（管理画面から `community-id` を変更）
- 旧 URL の無効化・リダイレクト処理
- 非公開スペースへの招待・アクセス制御
- QR コード生成・表示 UI の強化

---

## 現在の URL 設計（フェーズ1完了後）

| ルート | 対象 | 内容 |
|-------|------|------|
| `/` | 管理者 | トップ画面 |
| `/admin/login` | 管理者のみ | 管理者ログイン・コミュニティ登録申請画面 |
| `/s/[space-id]` | 参加者 | スペース直接アクセス（ゲスト/ログイン選択） |

---

## spaceURL（space-id）の仕様

| 項目 | 内容 |
|------|------|
| 形式 | 英小文字・数字・ハイフン（例: `mornings-team`） |
| 文字数 | 3〜40文字 |
| 先頭・末尾 | ハイフン不可 |
| 一意性 | 同一コミュニティ内でユニーク |
| 変更 | 管理画面からインライン編集可 |
| 自動生成 | スペース作成時にランダム 8 文字を付与 |

---

## URL 経由のスペースアクセスフロー

```
/s/[space-id] にアクセス
  │
  ├─ スペースが存在する
  │    │
  │    ├─ 未ログイン → ゲスト入室画面（ニックネーム入力）
  │    │                → スペース画面へ遷移（URL は /s/[space-id] を保持）
  │    │
  │    └─ ログイン済み → そのままスペース画面へ遷移
  │
  └─ スペースが存在しない → 「スペースが見つかりません」エラー画面
```

---

## 実装ステータス

| 機能 | 状態 |
|------|------|
| `spaceURL` の生成・保存 | ✅ 実装済み |
| `/s/[slug]` でのスペースアクセス | ✅ 実装済み |
| 招待 URL コピーボタン（管理画面） | ✅ 実装済み |
| QR コード生成・表示 | ✅ 実装済み |
| 入室後も URL バーに `/s/[slug]` を保持 | **フェーズ1（未実装）** |
| コミュニティ別スペース分離 | **フェーズ2（未実装）** |
| `/c/[community-id]/s/[space-id]/` URL への移行 | **フェーズ3（未実装）** |
| `community-id` のインライン編集 | **フェーズ4（未実装）** |
| 旧 URL のリダイレクト | **フェーズ4（未実装）** |
