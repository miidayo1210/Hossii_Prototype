# データ保存機能 仕様

> 最終更新: 2026-03-01

---

## 概要

Supabase をデータストアとして採用し、スペース・投稿・アカウント情報を
サーバー側に保存している。どの端末からでも同じデータを扱えるようになっている。
また、Supabase Realtime で投稿をリアルタイムに他の参加者へ届ける仕組みも実装済み。

> 以前は localStorage のみに保存していたが、Supabase への移行が完了している。

---

## 扱うデータの全体像

### データの種類と保存先

| データ種別 | 具体的な内容 | 保存先 | 優先度 |
|---|---|---|---|
| 管理者・コミュニティ | 管理者アカウント、コミュニティ名、メールアドレス | Supabase（Auth + communities テーブル） | 最高 |
| スペース | スペース名、spaceURL、カードタイプ、作成日時 | Supabase（spaces テーブル） | 最高 |
| スペースへの投稿 | メッセージ、気持ち、画像、数値、投稿者名 | Supabase（hossiis テーブル） | 最高 |
| スペースの UI 設定 | 背景画像・カラー・キャラクター設定・スペース名 | Supabase（space_settings テーブル） | 高 |
| スペースのデザイン | 背景パターン、キャラクター色、Hossii カラー | Supabase（space_settings テーブル） | 高 |
| 参加者アカウント（ログイン） | UID、ニックネーム、メールアドレス、スペース別ニックネーム | Supabase（Auth + profiles + space_nicknames テーブル） | 高 |
| 参加者アカウント（匿名） | 端末固有ID、ニックネーム、スペース別ニックネーム | localStorage（端末ローカルに保存） | 高 |
| スタンプカード | スタンプ数、獲得日時、カードテーマ | Supabase（stamps テーブル）※ログイン済みのみ | 中 |
| 表示設定・UI 好み | 表示スケール、Hossii 表示オン/オフ | localStorage（移行しない） | 低 |
| Listen 設定 | Listen モード、音声ログ設定、感情ログ設定 | localStorage（移行しない） | 低 |
| フィルター状態 | 投稿フィルターの選択状態 | localStorage（移行しない） | 低 |

---

## データ詳細

### 1. 管理者・コミュニティ

管理者は Supabase Auth でアカウントを持つ。コミュニティは管理者が登録する上位エンティティ。

| フィールド | 説明 |
|---|---|
| id | Supabase Auth の UID |
| communityName | コミュニティ名（表示用） |
| communityURL | パブリック URL 用スラッグ（将来: /c/[slug]） |
| email | メールアドレス |
| role | app_metadata.role = "admin" で管理者判定 |
| createdAt | 登録日時 |

> 詳細は `05_管理者ログイン画面.md` を参照

---

### 2. スペース

管理者がコミュニティ配下に作成するルーム。参加者は spaceURL 経由でアクセスする。

| フィールド | 説明 |
|---|---|
| id | 内部ID（変更不可） |
| spaceURL | パブリック URL 用スラッグ（変更可。例: mornings-team） |
| name | スペース名（表示用） |
| cardType | constellation / stamp |
| quickEmotions | クイックボタンに表示する感情（最大8種） |
| background | 背景設定（color / pattern / image） |
| createdAt | 作成日時 |

> 詳細は `03_スペースURL機能.md` を参照

---

### 3. 投稿（Hossii）

参加者がスペースに投稿するコンテンツ。投稿種別は今後も拡張予定。

| フィールド | 説明 | 現状 |
|---|---|---|
| id | 投稿ID | 実装済み |
| spaceId | 所属スペースID | 実装済み |
| message | テキストメッセージ（200文字以内） | 実装済み |
| emotion | 気持ち（joy / wow / think / empathy / inspire / laugh / moved / fun） | 実装済み |
| authorId | 投稿者の端末固有ID（匿名可） | 実装済み |
| authorName | 投稿者のニックネーム（表示用） | 実装済み |
| origin | 投稿元（manual / auto） | 実装済み |
| imageUrl | 添付画像の URL（Supabase Storage） | ✅ 実装済み |
| numberValue | 数値投稿（体温・歩数など） | ✅ 実装済み |
| createdAt | 投稿日時 | 実装済み |

投稿種別の拡張方針：`origin` と `autoType` の組み合わせで種別を表現する設計を維持しながら、`imageUrl`・`numberValue` などのフィールドを順次追加していく。

---

### 4. スペースの UI 設定・デザイン

管理者がスペースごとに設定するビジュアル・機能設定。

| フィールド | 説明 | 現状 |
|---|---|---|
| spaceName | スペース名 | 実装済み |
| backgroundPattern | 背景パターン（standard / nebula / galaxy / stars） | 実装済み |
| background（spaces テーブル） | 背景の種類と値（color / pattern / image） | 実装済み |
| hossiiColor | キャラクター色（pink / blue / yellow / green / purple） | 実装済み |
| cardType | 表示タイプ（constellation / stamp / graph） | 実装済み |
| characterImage | キャラクター画像の差し替え（カスタム画像） | 未実装 |
| features | 投稿種別ごとの ON/OFF 制御（コメント/気持ち/写真/数値） | 実装済み |

---

### 5. 参加者アカウント（ログイン済み）

Supabase Auth でログインした参加者。過去ログの閲覧や端末をまたいだ利用が可能。

| フィールド | 説明 |
|---|---|
| id（profiles） | 端末固有ID または Auth UID |
| defaultNickname | デフォルトニックネーム（全スペース共通） |
| スペース別ニックネーム（space_nicknames） | スペースごとの表示名 |
| createdAt | 初回登録日時 |

> 詳細は `02_匿名利用機能.md` および `05_管理者ログイン画面.md` を参照

---

### 6. 参加者アカウント（匿名）

ログイン不要でニックネームのみで参加するゲスト参加者。端末ローカルにのみ保存する。

| フィールド | 保存場所 | 説明 |
|---|---|---|
| 端末固有ID | localStorage（hossii.profile） | generateId() で生成。端末をまたいでの同一人物判定はできない |
| デフォルトニックネーム | localStorage（hossii.profile） | 全スペース共通のデフォルト名 |
| スペース別ニックネーム | localStorage（hossii.spaceNicknames） | スペースごとの表示名 |

匿名ユーザーの投稿は `authorId` に端末固有IDを設定して hossiis テーブルに保存する。投稿データ自体はサーバーに保存するが、プロフィール情報（ニックネーム）はローカルに留める。

---

## Supabase テーブル構成

既存のマイグレーション（`supabase/migrations/`）に定義済みのテーブルとの対応は以下の通り。

| テーブル | 用途 | 状態 |
|---|---|---|
| spaces | スペース一覧 | ✅ マイグレーション済み・読み書き実装済み |
| hossiis | 投稿データ | ✅ マイグレーション済み・読み書き実装済み |
| profiles | 参加者プロフィール（匿名・ログイン共通） | ✅ マイグレーション済み・読み書き実装済み |
| space_nicknames | スペース別ニックネーム | ✅ マイグレーション済み・読み書き実装済み |
| space_settings | スペース UI・機能設定 | マイグレーション済み（読み書き未実装） |
| stamps | スタンプカードデータ | マイグレーション済み（読み書き未実装） |
| communities | コミュニティ情報 | ✅ マイグレーション済み・読み書き実装済み |

---

## Supabase Realtime（リアルタイム同期）

投稿を別端末にリアルタイムで届けるために、Supabase Realtime を使用する。
現在の BroadcastChannel（同一ブラウザ内同期）を置き換える。

| イベント | 対象テーブル | フィルター |
|---|---|---|
| INSERT | hossiis | space_id = 現在のスペースID |
| DELETE | hossiis | space_id = 現在のスペースID |

---

## 実装ステップ（段階的）

| ステップ | 内容 | 完了条件 |
|---|---|---|
| 1 | Supabase クライアントのセットアップ（src/core/supabase.ts 作成、.env.local 設定） | supabase.from('spaces').select() が通る |
| 2 | スペースの読み書きを Supabase に移行 | 管理者が作成したスペースが別端末で招待 URL から開ける |
| 3 | 投稿の読み書きを Supabase に移行 | 別端末から投稿・閲覧ができる |
| 4 | Realtime 購読を実装 | 投稿が別端末にリアルタイムで反映される |
| 5 | プロフィール・ニックネームの Supabase 連携 | ログイン済み参加者のニックネームが端末をまたいで保持される |
| 6 | 画像投稿（Supabase Storage） | 写真添付が実際にアップロード・表示できる |
| 7 | communities テーブルの追加と管理者連携 | コミュニティ登録データが Supabase に保存される |
| 8 | RLS ポリシーの本番設定 | 管理者のみスペース作成可、投稿は参加者のみ可 |

---

## RLS ポリシーの方針

現状のマイグレーションでは全読み書きを許可している（デモ用）。
本番化の際は以下の方針でポリシーを設定する。

| テーブル | 読み取り | 書き込み | 削除 |
|---|---|---|---|
| spaces | 誰でも可 | 管理者（admin ロール）のみ | 管理者のみ |
| hossiis | 誰でも可 | 参加者（ログイン・匿名とも） | 投稿者本人・管理者 |
| profiles | 本人のみ | 本人のみ | 本人のみ |
| space_nicknames | 本人のみ | 本人のみ | 本人のみ |
| space_settings | 誰でも可 | 管理者のみ | 管理者のみ |
| stamps | 本人のみ | 本人のみ | 本人のみ |
| communities | 誰でも可 | 管理者のみ | 管理者のみ |

---

## Supabase Storage の設定

### バケット: `hossii-images`

画像投稿で使用するストレージバケット。

| 設定項目 | 値 |
|---------|-----|
| バケット名 | `hossii-images` |
| 公開設定 | Public（public read） |
| ファイルサイズ上限 | 5 MiB |
| 許可する MIME タイプ | `image/jpeg` / `image/png` / `image/gif` / `image/webp` |

### Storage RLS ポリシー

Storage バケットにも RLS ポリシーが必要。未設定の場合、画像アップロードが（権限エラーで）失敗し、リロード後に画像が消える。

| ポリシー名 | 対象操作 | 対象ロール | 条件 |
|-----------|---------|-----------|------|
| `public read hossii-images` | SELECT | 全員 | `bucket_id = 'hossii-images'` |
| `auth upload hossii-images` | INSERT | authenticated のみ | `bucket_id = 'hossii-images'` |
| `auth update hossii-images` | UPDATE | authenticated のみ | `bucket_id = 'hossii-images'` |
| `auth delete hossii-images` | DELETE | authenticated のみ | `bucket_id = 'hossii-images'` |

マイグレーションファイル: `supabase/migrations/20260301000001_add_storage_policies.sql`

### 画像アップロードフロー

```
ユーザーが画像を選択
  │
  └─ Canvas API でクライアント側圧縮（最大幅 1200px, JPEG 品質 0.7）
       │
       └─ Supabase Storage（hossii-images バケット）にアップロード
            │
            ├─ 成功 → 公開 URL を取得 → hossiis テーブルの image_url に保存
            └─ 失敗 → objectURL のまま表示（リロード後に消える ← RLS 未設定時の症状）
```

> **注意:** objectURL はブラウザのメモリ上にのみ存在するため、リロードで消える。
> Storage への実アップロードが成功しているかを確認するには、`hossiis.image_url` が `null` でないことを確認する。

---

## 実装ステータス

| 機能 | 状態 |
|---|---|
| Supabase テーブル定義（migration） | ✅ 完了 |
| Supabase クライアントのセットアップ | ✅ 完了（`src/core/supabase.ts`） |
| スペースの Supabase 読み書き | ✅ 完了（`src/core/utils/spacesApi.ts`） |
| 投稿の Supabase 読み書き | ✅ 完了（`src/core/utils/hossiisApi.ts`） |
| Realtime 購読（hossiis INSERT/DELETE） | ✅ 完了（`useHossiiStore.tsx` 内） |
| プロフィールの Supabase 連携 | ✅ 完了（`src/core/utils/profilesApi.ts`） |
| communities テーブル追加・管理者連携 | ✅ 完了（`src/core/utils/communitiesApi.ts`） |
| 画像投稿（Supabase Storage アップロード） | ✅ 完了 |
| Storage RLS ポリシー（`hossii-images` バケット） | ✅ 完了（`20260301000001_add_storage_policies.sql`） |
| テーブル RLS 本番設定 | **未実装** |
