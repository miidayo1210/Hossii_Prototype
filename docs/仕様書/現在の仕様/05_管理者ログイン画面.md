# 管理者ログイン・ユーザー認証 仕様

> 最終更新: 2026-02-25
> 関連ファイル:
> `src/core/contexts/AuthContext.tsx`
> `src/core/firebase.ts`
> `src/components/Auth/LoginScreen.tsx`
> `src/components/StartScreen/StartScreen.tsx`
> `src/App.tsx`

---

## 概要

Hossii には 3 種類のユーザーが存在する。

| 種別 | 説明 | 認証 | スペース作成 |
|---|---|---|---|
| **管理者** | コミュニティを登録し、スペースを作成・管理する | Supabase Auth ログイン必須（admin ロール） | ✅ 可能 |
| **ログイン済み参加者** | スペース URL 経由でアカウントにログインして参加する。過去ログの閲覧が可能 | Supabase Auth ログイン任意 | ❌ 不可（将来対応予定） |
| **ゲスト参加者** | スペース URL 経由でニックネームのみで参加する | ログイン不要（匿名利用） | ❌ 不可 |

現状は認証が**モック実装**であり、3種別の区別が存在しない。
また、トップ画面からログイン画面に誰でもアクセスできる状態になっている。

---

## コミュニティとスペース作成権限

### コミュニティとは

Hossii における「コミュニティ」は、スペースを所有・管理する上位エンティティ。
コミュニティを登録した人が管理者となり、その配下にスペースを複数作成できる。

| エンティティ | 作成者 | 備考 |
|---|---|---|
| コミュニティ | 管理者（招待制・有料プラン想定） | Supabase ダッシュボードから登録 |
| スペース | 管理者のみ | コミュニティ配下に作成 |

### 現在の制限

- スペースの作成は **管理者（`app_metadata.role === "admin"`）のみ** に制限する
- 一般のアカウント保有者はスペースを作成できない

### 将来の方針

- 個人アカウント保有者も自分自身のスペースを作成できるようにすることを検討している
- その場合、個人スペースはコミュニティとは独立した名前空間（`/s/[slug]`）で管理する

---

## 課題

- 管理者ログイン画面がトップ画面から誰でもアクセスできる
- どんな email / password でもログインが通ってしまう（モック）
- スペースの作成権限が全ユーザーに開放されている
- 管理者かどうかを判定する仕組みが存在しない
- `/s/[slug]` アクセス時のゲスト/ログイン選択フローが未実装

---

## 実装ステータス

| 機能 | 状態 |
|---|---|
| ログイン UI（メール・Google） | 実装済み（モック） |
| Supabase Auth との接続 | **未実装** |
| 管理者権限チェック | **未実装** |
| 管理者専用ルート（`/admin/login`） | **未実装** |
| トップ画面からの導線を非公開化 | **未実装** |
| `/s/[slug]` でのゲスト/ログイン選択画面 | **未実装** |
| ログイン済み参加者の過去ログ閲覧 | **未実装** |
| スペース作成の管理者制限 | **未実装** |
| 管理側とスペース側のナビ分離 | **未実装** |
| スペース Home の表示切り替えボタン | **未実装** |

---

## アクセス方法（URL 設計）

管理者ログイン画面は **一般ユーザーから隠す** ことを前提とする。

| ルート | 対象 | 内容 |
|---|---|---|
| `/` | 管理者 | トップ画面（ログインボタンなし。管理者は URL を直接知っている） |
| `/s/[slug]` | 一般ユーザー | スペース直接アクセス（ゲスト/ログイン選択） |
| `/admin/login` | 管理者のみ | 管理者ログイン画面（URL を知っている者のみアクセス可） |

- トップ画面（`StartScreen`）には「管理者はこちら」などのリンクを置かない
- `/admin/login` の URL は管理者のみに共有する

---

## 管理画面とスペース画面の分離方針

### 分離の理由

スペース画面には一般の参加者がアクセスする。参加者が管理画面（スペース設定・スペース一覧・ログ管理等）を閲覧・操作できてしまうのは望ましくないため、管理側とスペース側の導線を完全に分離する。

### 導線の方向性（片方向）

```
管理画面（/admin/*）
  │
  └─ スペースを作成すると spaceURL が生成される
       │
       └─ /s/[slug] を参加者に共有する
            │
            └─ スペース参加者 UI（管理画面への導線なし）
```

- 管理者は管理画面でスペースを作成し、生成された `/s/[slug]` URL を参加者に共有する
- **管理者自身がスペース画面を確認したい場合も、`/s/[slug]` URL から遷移する**
- スペース画面（`/s/[slug]`）から管理画面へ戻る手段は一切提供しない

---

## `/s/[slug]` アクセスフロー

スペース URL を開いた参加者は、以下の選択を行う。

```
/s/[slug] にアクセス
  │
  ├─ (a) ゲストとして参加
  │       → ニックネームを入力
  │       → スペース参加者 UI（4タブ）へ遷移
  │       → 過去ログは閲覧不可
  │
  └─ (b) アカウントにログインして参加
          → ログイン画面（メール or Google）
          → ログイン成功後、スペース参加者 UI（4タブ）へ遷移
          → 過去ログの閲覧が可能
```

### スペース参加者 UI の構成（4タブ・横並び）

| タブ | 画面 | 説明 |
|---|---|---|
| Home | スペース画面 | 投稿が流れるメイン画面。表示切り替えボタンあり |
| ログを置く | 投稿画面 | テキスト・気持ちを投稿 |
| ログ一覧 | コメント一覧 | 投稿フィルター付き一覧 |
| アカウント | アカウント画面 | ニックネーム確認・ログイン状態 |

- 管理系画面（スペース設定・スペース一覧・マイログ等）は表示しない
- 管理側へ戻る導線を一切持たない

### 表示切り替えボタン

Home 画面には、スペースの表示形式を切り替えるボタンを設ける。

| 表示モード | 説明 |
|---|---|
| 星座（デフォルト） | 投稿がバブル・星として浮かぶ表示 |
| スタンプカード | スタンプ形式でログを一覧表示 |

- ボタンはスペース画面内に常時表示し、タップ/クリックで即時切り替え
- 選択状態はスペースごとにローカルに保持する（将来的にはサーバーに保存）

---

## 認証基盤

**Supabase Auth** を使用する。

> 現在の `firebase.ts` はダミーファイルであり Firebase SDK は使用していない。
> `AuthContext.tsx` のモック実装を Supabase Auth に置き換える。

### 対応する認証メソッド

| メソッド | 管理者画面 | 参加者ログイン | 備考 |
|---|---|---|---|
| メール＋パスワード | ✅ | ✅ | 管理者はログインのみ（新規登録なし） |
| Google OAuth | ✅ | ✅ | Supabase の OAuth Provider を使用 |
| Facebook OAuth | ❌ | ❌ | 提供しない |

管理者の新規登録は Supabase ダッシュボードから直接行う想定。
**管理者ログイン画面にサインアップ機能は設けない。**

---

## 管理者権限チェック

Supabase Auth でのログイン成功 ≠ 管理者権限あり。
ログイン後に以下の方法で管理者かどうかを判定する。

### 方式：`app_metadata` によるロールチェック（推奨）

Supabase の `app_metadata` に `{ role: "admin" }` を設定する。
`app_metadata` はユーザー自身では変更できない（サービスロールキーが必要）ためセキュア。

```
ログイン成功
  │
  ├─ app_metadata.role === "admin" → 管理ダッシュボードへ遷移
  └─ それ以外 → エラーメッセージを表示して自動ログアウト
```

### エラーメッセージ（権限なしの場合）

> 「このアカウントには管理者権限がありません。」

---

## 画面仕様

### 管理者ログイン画面（`/admin/login`）

```
┌──────────────────────────────┐
│                              │
│         ✨ Hossii            │
│       管理者ログイン          │
│                              │
│  [  Googleでログイン  ]      │
│                              │
│  ─────────── または ──────── │
│                              │
│  メールアドレス              │
│  [         入力欄          ] │
│                              │
│  パスワード                  │
│  [         入力欄          ] │
│                              │
│  [       ログイン           ]│
│                              │
│  ※ このページは管理者専用です │
│                              │
└──────────────────────────────┘
```

#### 表示要素

| 要素 | 内容 |
|---|---|
| タイトル | 「管理者ログイン」と明示する |
| 認証方法 | Google ログイン / メール＋パスワード |
| サインアップ | 表示しない |
| 「匿名で使う」導線 | 置かない |
| 注意書き | 「このページは管理者専用です」 |

#### 既存の `LoginScreen` との差分

| 項目 | 既存 `LoginScreen` | 管理者ログイン画面 |
|---|---|---|
| タブ（ログイン/新規登録） | あり | なし（ログインのみ） |
| Facebook ログイン | あり | なし |
| 「または」区切り | あり | あり |
| 管理者専用の注意書き | なし | あり |

---

## ログイン後の遷移

```
/admin/login
  │
  ├─ ログイン成功
  │    │
  │    ├─ app_metadata.role === "admin"
  │    │      → SpacesScreen（スペース管理画面）へ遷移
  │    │
  │    └─ role が admin でない
  │           → 「管理者権限がありません」を表示
  │           → 自動ログアウト
  │           → /admin/login に戻る
  │
  └─ ログイン失敗（認証エラー）
         → エラーメッセージを表示
         → 画面にとどまる
```

---

## 導線の分離（管理者 vs 一般ユーザー）

| 項目 | 現状 | 目標 |
|---|---|---|
| トップ画面のログインボタン | あり（管理者ログインに直結） | 削除する |
| 一般ユーザーの入口 | StartScreen → LoginScreen | `/s/[slug]` → ゲスト/ログイン選択 |
| 管理者の入口 | StartScreen → LoginScreen（同じ） | `/admin/login`（独立した画面） |
| スペース参加後のナビ | 管理系メニューが混在 | 4タブのみ（管理系なし） |

> 詳細は `02_匿名利用機能.md` を参照。

---

## 将来の実装方針

- `AuthContext.tsx` のモック実装を `@supabase/supabase-js` に置き換える
- `supabase.auth.signInWithPassword()` / `signInWithOAuth({ provider: 'google' })` を使用
- ログイン後に `supabase.auth.getUser()` の `app_metadata.role` を確認
- 管理者ルート（`/admin/*`）へのアクセスは認証ガードで保護する
- `StartScreen` からログインボタンを削除し、一般ユーザーは `/s/[slug]` から入室する
- 将来的には個人アカウント保有者も自分のスペースを作成できる仕組みを検討する
