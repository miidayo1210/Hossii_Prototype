# 管理者ログイン・コミュニティ登録・スペース管理 仕様

> 最終更新: 2026-02-25
> 関連ファイル:
> `src/core/contexts/AuthContext.tsx`
> `src/core/firebase.ts`
> `src/components/Auth/AdminLoginScreen.tsx`
> `src/components/SpacesScreen/SpacesScreen.tsx`
> `src/components/SpacesScreen/SpacesScreen.module.css`
> `src/components/StartScreen/StartScreen.tsx`
> `src/core/types/space.ts`
> `src/core/utils/spaceUrlUtils.ts`
> `src/App.tsx`

---

## 概要

Hossii には 3 種類のユーザーが存在する。

| 種別 | 説明 | 認証 | スペース作成 |
|---|---|---|---|
| **管理者** | コミュニティを登録し、スペースを作成・管理する | Supabase Auth ログイン必須（admin ロール） | ✅ 可能 |
| **ログイン済み参加者** | スペース URL 経由でアカウントにログインして参加する。過去ログの閲覧が可能 | Supabase Auth ログイン任意 | ❌ 不可（将来対応予定） |
| **ゲスト参加者** | スペース URL 経由でニックネームのみで参加する | ログイン不要（匿名利用） | ❌ 不可 |

現状は認証が**モック実装**であり、3種別の区別が存在しない。
また、トップ画面からログイン画面に誰でもアクセスできる状態になっている。

---

## コミュニティとスペース作成権限

### コミュニティとは

Hossii における「コミュニティ」は、スペースを所有・管理する上位エンティティ。
コミュニティを登録した人が管理者となり、その配下にスペースを複数作成できる。

| エンティティ | 作成者 | 備考 |
|---|---|---|
| コミュニティ | 管理者（招待制・有料プラン想定） | 管理者ログイン画面の新規登録フォームから作成 |
| スペース | 管理者のみ | コミュニティ配下に作成 |

### 現在の制限

- スペースの作成は **管理者（`app_metadata.role === "admin"`）のみ** に制限する
- 一般のアカウント保有者はスペースを作成できない

### 将来の方針

- 個人アカウント保有者も自分自身のスペースを作成できるようにすることを検討している
- その場合、個人スペースはコミュニティとは独立した名前空間（`/s/[slug]`）で管理する

---

## 課題

- 管理者ログイン画面がトップ画面から誰でもアクセスできる
- どんな email / password でもログインが通ってしまう（モック）
- スペースの作成権限が全ユーザーに開放されている
- 管理者かどうかを判定する仕組みが存在しない
- `/s/[slug]` アクセス時のゲスト/ログイン選択フローが未実装
- `loginWithGoogle` を管理者画面から呼ぶと `isAdmin: true` が無条件に付与される（後述）

---

## 実装ステータス

| 機能 | 状態 |
|---|---|
| ログイン UI（メール・Google） | 実装済み（モック） |
| コミュニティ新規登録 UI（メール・Google） | **未実装** |
| Supabase Auth との接続 | **未実装** |
| 管理者権限チェック | **未実装** |
| 管理者専用ルート（`/admin/login`） | **未実装** |
| トップ画面からの導線を非公開化 | **未実装** |
| `/s/[slug]` でのゲスト/ログイン選択画面 | **未実装** |
| ログイン済み参加者の過去ログ閲覧 | **未実装** |
| スペース作成の管理者制限 | **未実装** |
| 管理側とスペース側のナビ分離 | **未実装** |
| スペース管理画面のカードグリッドレイアウト | **未実装** |
| スペースの spaceURL インライン編集 | 実装済み（SpaceSettingsScreen 経由） |

---

## アクセス方法（URL 設計）

管理者ログイン画面は **一般ユーザーから隠す** ことを前提とする。

| ルート | 対象 | 内容 |
|---|---|---|
| `/` | 管理者 | トップ画面（ログインボタンなし。管理者は URL を直接知っている） |
| `/s/[slug]` | 一般ユーザー | スペース直接アクセス（ゲスト/ログイン選択） |
| `/admin/login` | 管理者のみ | 管理者ログイン・コミュニティ登録画面（URL を知っている者のみアクセス可） |

- トップ画面（`StartScreen`）には「管理者はこちら」などのリンクを置かない
- `/admin/login` の URL は管理者のみに共有する

---

## 管理画面とスペース画面の分離方針

### 分離の理由

スペース画面には一般の参加者がアクセスする。参加者が管理画面（スペース設定・スペース一覧・ログ管理等）を閲覧・操作できてしまうのは望ましくないため、管理側とスペース側の導線を完全に分離する。

### 導線の方向性（片方向）

```
管理画面（/admin/*）
  │
  └─ スペースを作成すると spaceURL が生成される
       │
       └─ /s/[slug] を参加者に共有する
            │
            └─ スペース参加者 UI（管理画面への導線なし）
```

- 管理者は管理画面でスペースを作成し、生成された `/s/[slug]` URL を参加者に共有する
- **管理者自身がスペース画面を確認したい場合も、`/s/[slug]` URL から遷移する**
- スペース画面（`/s/[slug]`）から管理画面へ戻る手段は一切提供しない

---

## `/s/[slug]` アクセスフロー

スペース URL を開いた参加者は、以下の選択を行う。

```
/s/[slug] にアクセス
  │
  ├─ (a) ゲストとして参加
  │       → ニックネームを入力
  │       → スペース参加者 UI（4タブ）へ遷移
  │       → 過去ログは閲覧不可
  │
  └─ (b) アカウントにログインして参加
          → ログイン画面（メール or Google）
          → ログイン成功後、スペース参加者 UI（4タブ）へ遷移
          → 過去ログの閲覧が可能
```

### スペース参加者 UI の構成（4タブ・横並び）

| タブ | 画面 | 説明 |
|---|---|---|
| Home | スペース画面 | 投稿が流れるメイン画面。表示切り替えボタンあり |
| ログを置く | 投稿画面 | テキスト・気持ちを投稿 |
| ログ一覧 | コメント一覧 | 投稿フィルター付き一覧 |
| アカウント | アカウント画面 | ニックネーム確認・ログイン状態 |

- 管理系画面（スペース設定・スペース一覧・マイログ等）は表示しない
- 管理側へ戻る導線を一切持たない

### 表示切り替えボタン

Home 画面には、スペースの表示形式を切り替えるボタンを設ける。

| 表示モード | 説明 |
|---|---|
| 星座（デフォルト） | 投稿がバブル・星として浮かぶ表示 |
| スタンプカード | スタンプ形式でログを一覧表示 |

- ボタンはスペース画面内に常時表示し、タップ/クリックで即時切り替え
- 選択状態はスペースごとにローカルに保持する（将来的にはサーバーに保存）

---

## 認証基盤

**Supabase Auth** を使用する。

> 現在の `firebase.ts` はダミーファイルであり Firebase SDK は使用していない。
> `AuthContext.tsx` のモック実装を Supabase Auth に置き換える。

### 対応する認証メソッド

| メソッド | 管理者画面 | 参加者ログイン | 備考 |
|---|---|---|---|
| メール＋パスワード | ✅ | ✅ | ログイン・新規登録ともに対応 |
| Google OAuth | ✅ | ✅ | Supabase の OAuth Provider を使用 |
| Facebook OAuth | ❌ | ❌ | 提供しない |

---

## 管理者権限チェック

Supabase Auth でのログイン成功 ≠ 管理者権限あり。
ログイン後に以下の方法で管理者かどうかを判定する。

### 方式：`app_metadata` によるロールチェック（推奨）

Supabase の `app_metadata` に `{ role: "admin" }` を設定する。
`app_metadata` はユーザー自身では変更できない（サービスロールキーが必要）ためセキュア。

```
ログイン成功
  │
  ├─ app_metadata.role === "admin" → 管理ダッシュボードへ遷移
  └─ それ以外 → エラーメッセージを表示して自動ログアウト
```

### エラーメッセージ（権限なしの場合）

> 「このアカウントには管理者権限がありません。」

### ⚠️ 既知の技術的負債：`loginWithGoogle` の isAdmin 無条件付与

**対象ファイル**: `src/core/contexts/AuthContext.tsx`

現在のモック実装では、`loginWithGoogle` を管理者画面（`/admin/login`）から呼び出すと `isAdmin: true` が**無条件に付与**される。これは呼び出し元の画面を信頼しているだけで、実際に権限チェックを行っていない。

```
現状（モック）:
  管理者画面から loginWithGoogle を呼ぶ → isAdmin: true が付与される
  ↑ 画面を改ざんすれば誰でも管理者になれてしまう（デモ用途限定）
```

**修正方針（優先度: 高）**

以下のいずれかで対処する：

| 方針 | タイミング | 内容 |
|---|---|---|
| メールアドレスで判定（暫定） | Supabase 接続前 | `adminLogin` と同様に、許可済みメールアドレスのリストで判定する |
| `app_metadata.role` で一元管理（本対応） | Supabase Auth 接続後 | `loginWithGoogle` 成功後に `supabase.auth.getUser()` の `app_metadata.role === "admin"` を確認し、付与可否を判定する |

Supabase Auth 接続後は後者に一本化し、ログイン方法（メール/Google）に関わらず同一のロールチェックを適用すること。

---

## 画面仕様

### 管理者ログイン・コミュニティ登録画面（`/admin/login`）

ログインと新規登録（コミュニティ登録）を **タブで切り替える** 1画面として実装する。

```
┌──────────────────────────────────────┐
│                                      │
│           ✨ Hossii                  │
│                                      │
│  [ ログイン  |  コミュニティを登録 ] │  ← タブ切り替え
│                                      │
│  [    Googleでログイン / 登録    ]   │
│                                      │
│  ──────────── または ──────────────  │
│                                      │
│  【ログインタブの場合】               │
│  メールアドレス                      │
│  [           入力欄               ]  │
│                                      │
│  パスワード                          │
│  [           入力欄               ]  │
│                                      │
│  [          ログイン              ]  │
│                                      │
│  【コミュニティを登録タブの場合】     │
│  コミュニティ名                      │
│  [           入力欄               ]  │
│                                      │
│  メールアドレス                      │
│  [           入力欄               ]  │
│                                      │
│  パスワード                          │
│  [           入力欄               ]  │
│                                      │
│  [      コミュニティを登録        ]  │
│                                      │
│  ※ このページは管理者専用です        │
│                                      │
└──────────────────────────────────────┘
```

#### 表示要素

| 要素 | ログインタブ | コミュニティ登録タブ |
|---|---|---|
| タイトル | 「管理者ログイン」 | 「コミュニティを登録」 |
| タブ | ログイン / コミュニティを登録 | 同左 |
| Google ボタン | 「Googleでログイン」 | 「Googleで登録」 |
| コミュニティ名フィールド | なし | あり |
| メール＋パスワード | あり | あり |
| サインアップ向け誘導リンク | なし | なし（タブで完結） |
| 「匿名で使う」導線 | なし | なし |
| 注意書き | 「このページは管理者専用です」 | 同左 |

#### 既存の `LoginScreen` との差分

| 項目 | 既存 `LoginScreen` | 管理者ログイン・登録画面 |
|---|---|---|
| タブ（ログイン/新規登録） | あり（参加者向け） | あり（ログイン/コミュニティ登録） |
| Facebook ログイン | あり | なし |
| コミュニティ名フィールド | なし | 登録タブのみあり |
| 管理者専用の注意書き | なし | あり |

---

### スペース管理画面（`SpacesScreen`）

**PC 利用前提**。管理者がスペースを一覧・作成・管理する画面。

#### ページレイアウト

```
┌─────────────────────────────────────────────────────────────┐
│  ✨ Hossii スペース管理            [+新しいスペース] [👤] │  ← ページ右上ナビ
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  │
│  │ [背景]   │  │ [背景]   │  │ [背景]   │  │ [背景]   │  │
│  │          │  │          │  │          │  │          │  │
│  │ スペース名│  │ スペース名│  │ スペース名│  │ スペース名│  │
│  │──────────│  │──────────│  │──────────│  │──────────│  │
│  │ タイプ:  │  │ タイプ:  │  │ タイプ:  │  │ タイプ:  │  │
│  │ 星座     │  │ 星座     │  │ 星座     │  │ 星座     │  │
│  │──────────│  │──────────│  │──────────│  │──────────│  │
│  │ ID: abc… │  │ ID: xyz… │  │ ID: def… │  │ ID: ghi… │  │
│  │ [編集]   │  │ [編集]   │  │ [編集]   │  │ [編集]   │  │
│  │──────────│  │──────────│  │──────────│  │──────────│  │
│  │ [🔗コピー│  │ [🔗コピー│  │ [🔗コピー│  │ [🔗コピー│  │
│  │ 招待URL] │  │ 招待URL] │  │ 招待URL] │  │ 招待URL] │  │
│  │──────────│  │──────────│  │──────────│  │──────────│  │
│  │ [✏名前変]│  │ [✏名前変]│  │ [✏名前変]│  │ [✏名前変]│  │
│  │ [🗑削除] │  │ [🗑削除] │  │ [🗑削除] │  │ [🗑削除] │  │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘  │
│                                                             │
│  （5枚目以降は次の行へ折り返し）                           │
└─────────────────────────────────────────────────────────────┘
```

#### ページ右上ナビゲーション

| ボタン | 種別 | 動作 |
|---|---|---|
| `+ 新しいスペースを作成` | プライマリボタン | スペース作成モーダルを開く |
| `👤 アカウント` | ドロップダウン | コミュニティ名・メールアドレス・ログアウトを表示 |

- `TopRightMenu` コンポーネントを管理者用に更新する
- 現状の汎用メニューとは別に `AdminTopNav` を作成することも検討

#### スペースカードの表示項目

| 項目 | 説明 | 操作 |
|---|---|---|
| 背景サムネイル | カード上部にプレビュー表示 | クリックで背景選択パネルを開く |
| スペース名 | カード内に大きく表示 | 名前変更ボタンでインライン編集 |
| カードタイプ | 星座 / スタンプ | セレクトで変更（将来: タイプを追加） |
| スペース ID（`spaceURL`） | ランダム生成の短いスラッグ（例: `abc123xy`）。`/s/[ID]` の末尾になる | 編集ボタンでインライン編集。ユニーク・英数字ハイフンのみ・3〜40文字 |
| 招待 URL コピー | `/s/[spaceURL]` 形式の URL をクリップボードにコピー | コピーボタン（コピー完了で「コピー!」に変化） |
| 名前変更 | スペース名を変更するフォームを展開 | 編集ボタン |
| 削除 | スペースを削除 | 削除ボタン（確認ダイアログあり） |
| （将来）コメント数など | 現在の投稿数・アクティブ人数など | 将来追加 |

#### スペース ID（`spaceURL`）の仕様

- `Space` 型の `spaceURL` フィールドを使用（既存）
- 初期値は `generateSpaceURL()` でランダム生成（8文字英数字）
- 編集ルール: `validateSpaceURL()` で検証（3〜40文字、英小文字・数字・ハイフン、先頭末尾ハイフン不可）
- 同一コミュニティ内でユニークであること（`isSpaceURLUnique()` で検証）
- 参照: `src/core/utils/spaceUrlUtils.ts`

#### スペース作成モーダル

右上の「新しいスペースを作成」ボタンを押すと表示されるモーダル。

| フィールド | 説明 |
|---|---|
| スペース名 | 必須。テキスト入力 |
| スペース ID（`spaceURL`） | 自動生成（変更可）。バリデーション付き |
| カードタイプ | 星座（デフォルト） / スタンプ から選択 |

- 作成ボタンを押すとモーダルを閉じ、グリッドに新しいカードを追加する
- 従来のページ内フォームは廃止する

#### グリッドのレスポンシブ対応

| 画面幅 | カード列数 |
|---|---|
| 1280px 以上 | 4列 |
| 900px〜1279px | 3列 |
| 600px〜899px | 2列 |
| 600px 未満 | 1列（モバイルフォールバック） |

---

## ログイン後の遷移

```
/admin/login
  │
  ├─ ログイン成功
  │    │
  │    ├─ app_metadata.role === "admin"
  │    │      → SpacesScreen（スペース管理画面）へ遷移
  │    │
  │    └─ role が admin でない
  │           → 「管理者権限がありません」を表示
  │           → 自動ログアウト
  │           → /admin/login に戻る
  │
  ├─ ログイン失敗（認証エラー）
  │      → エラーメッセージを表示
  │      → 画面にとどまる
  │
  └─ コミュニティ登録成功
         → app_metadata.role = "admin" を付与（Supabase 側で設定）
         → SpacesScreen へ遷移
```

---

## 導線の分離（管理者 vs 一般ユーザー）

| 項目 | 現状 | 目標 |
|---|---|---|
| トップ画面のログインボタン | あり（管理者ログインに直結） | 削除する |
| 一般ユーザーの入口 | StartScreen → LoginScreen | `/s/[slug]` → ゲスト/ログイン選択 |
| 管理者の入口 | StartScreen → LoginScreen（同じ） | `/admin/login`（独立した画面） |
| スペース参加後のナビ | 管理系メニューが混在 | 4タブのみ（管理系なし） |

> 詳細は `02_匿名利用機能.md` を参照。

---

## 将来の実装方針

- `AuthContext.tsx` のモック実装を `@supabase/supabase-js` に置き換える
- `supabase.auth.signInWithPassword()` / `signInWithOAuth({ provider: 'google' })` を使用
- コミュニティ登録時は `supabase.auth.signUp()` を呼び、Supabase 側で `app_metadata.role = "admin"` を付与する
- ログイン後に `supabase.auth.getUser()` の `app_metadata.role` を確認
- 管理者ルート（`/admin/*`）へのアクセスは認証ガードで保護する
- `StartScreen` からログインボタンを削除し、一般ユーザーは `/s/[slug]` から入室する
- 将来的には個人アカウント保有者も自分のスペースを作成できる仕組みを検討する
- スペースカードに投稿数・アクティブ人数などのメトリクスを追加する
