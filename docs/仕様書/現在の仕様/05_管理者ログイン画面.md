# 管理者ログイン画面 仕様

> 最終更新: 2026-02-25
> 関連ファイル:
> `src/core/contexts/AuthContext.tsx`
> `src/core/firebase.ts`
> `src/components/Auth/LoginScreen.tsx`
> `src/components/StartScreen/StartScreen.tsx`
> `src/App.tsx`

---

## 概要

Hossii には 2 種類のユーザーが存在する。

| 種別 | 説明 | 認証 |
|---|---|---|
| **管理者** | スペースを作成・管理し、招待 URL を発行する | Supabase Auth でログイン必須 |
| **一般ユーザー** | スペース URL 経由で匿名投稿する | ログイン不要（匿名利用） |

現状は認証が**モック実装**であり、管理者・一般ユーザーの区別が存在しない。
また、トップ画面からログイン画面に誰でもアクセスできる状態になっている。

---

## 課題

- 管理者ログイン画面がトップ画面から誰でもアクセスできる
- どんな email / password でもログインが通ってしまう（モック）
- スペースの作成権限が全ユーザーに開放されている
- 管理者かどうかを判定する仕組みが存在しない

---

## 実装ステータス

| 機能 | 状態 |
|---|---|
| ログイン UI（メール・Google） | 実装済み（モック） |
| Supabase Auth との接続 | **未実装** |
| 管理者権限チェック | **未実装** |
| 管理者専用ルート（`/admin/login`） | **未実装** |
| トップ画面からの導線を非公開化 | **未実装** |

---

## アクセス方法（URL 設計）

管理者ログイン画面は **一般ユーザーから隠す** ことを前提とする。

| ルート | 内容 |
|---|---|
| `/` | トップ画面（一般ユーザー向け。ログインボタンなし） |
| `/s/[slug]` | スペース直接アクセス（一般ユーザー向け） |
| `/admin/login` | 管理者ログイン画面（URL を知っている者のみアクセス可） |

- トップ画面（`StartScreen`）には「管理者はこちら」などのリンクを置かない
- `/admin/login` の URL は管理者のみに共有する

---

## 認証基盤

**Supabase Auth** を使用する。

> 現在の `firebase.ts` はダミーファイルであり Firebase SDK は使用していない。
> `AuthContext.tsx` のモック実装を Supabase Auth に置き換える。

### 対応する認証メソッド

| メソッド | 管理者画面 | 備考 |
|---|---|---|
| メール＋パスワード | ✅ | ログインのみ（新規登録なし） |
| Google OAuth | ✅ | Supabase の OAuth Provider を使用 |
| Facebook OAuth | ❌ | 管理者画面では提供しない |

新規登録は管理者が Supabase ダッシュボードから直接行う想定。
**管理者ログイン画面にサインアップ機能は設けない。**

---

## 管理者権限チェック

Supabase Auth でのログイン成功 ≠ 管理者権限あり。
ログイン後に以下の方法で管理者かどうかを判定する。

### 方式：`app_metadata` によるロールチェック（推奨）

Supabase の `app_metadata` に `{ role: "admin" }` を設定する。
`app_metadata` はユーザー自身では変更できない（サービスロールキーが必要）ためセキュア。

```
ログイン成功
  │
  ├─ app_metadata.role === "admin" → 管理ダッシュボードへ遷移
  └─ それ以外 → エラーメッセージを表示して自動ログアウト
```

### エラーメッセージ（権限なしの場合）

> 「このアカウントには管理者権限がありません。」

---

## 画面仕様

### 管理者ログイン画面（`/admin/login`）

```
┌──────────────────────────────┐
│                              │
│         ✨ Hossii            │
│       管理者ログイン          │
│                              │
│  [  Googleでログイン  ]      │
│                              │
│  ─────────── または ──────── │
│                              │
│  メールアドレス              │
│  [         入力欄          ] │
│                              │
│  パスワード                  │
│  [         入力欄          ] │
│                              │
│  [       ログイン           ]│
│                              │
│  ※ このページは管理者専用です │
│                              │
└──────────────────────────────┘
```

#### 表示要素

| 要素 | 内容 |
|---|---|
| タイトル | 「管理者ログイン」と明示する |
| 認証方法 | Google ログイン / メール＋パスワード |
| サインアップ | 表示しない |
| 「匿名で使う」導線 | 置かない |
| 注意書き | 「このページは管理者専用です」 |

#### 既存の `LoginScreen` との差分

| 項目 | 既存 `LoginScreen` | 管理者ログイン画面 |
|---|---|---|
| タブ（ログイン/新規登録） | あり | なし（ログインのみ） |
| Facebook ログイン | あり | なし |
| 「または」区切り | あり | あり |
| 管理者専用の注意書き | なし | あり |

---

## ログイン後の遷移

```
/admin/login
  │
  ├─ ログイン成功
  │    │
  │    ├─ app_metadata.role === "admin"
  │    │      → SpacesScreen（スペース管理画面）へ遷移
  │    │
  │    └─ role が admin でない
  │           → 「管理者権限がありません」を表示
  │           → 自動ログアウト
  │           → /admin/login に戻る
  │
  └─ ログイン失敗（認証エラー）
         → エラーメッセージを表示
         → 画面にとどまる
```

---

## 一般ユーザーとの導線の分離

| 項目 | 現状 | 目標 |
|---|---|---|
| トップ画面のログインボタン | あり（管理者ログインに直結） | 削除する |
| 一般ユーザーの入口 | StartScreen → LoginScreen | スペース URL `/s/[slug]` から直接入室 |
| 管理者の入口 | StartScreen → LoginScreen（同じ） | `/admin/login`（独立した画面） |

> 詳細は `02_匿名利用機能.md` を参照。

---

## 将来の実装方針

- `AuthContext.tsx` のモック実装を `@supabase/supabase-js` に置き換える
- `supabase.auth.signInWithPassword()` / `signInWithOAuth({ provider: 'google' })` を使用
- ログイン後に `supabase.auth.getUser()` の `app_metadata.role` を確認
- 管理者ルート（`/admin/*`）へのアクセスは認証ガードで保護する
- `StartScreen` からログインボタンを削除し、一般ユーザーは匿名で直接スペースへ入室できるようにする
