# 投稿画面 UI/UX 仕様書

> 最終更新: 2026-02-27
> 関連ファイル:
> `src/components/PostScreen/PostScreen.tsx`
> `src/components/PostScreen/PostScreen.module.css`
> `src/core/utils/imageStorageApi.ts`
> `src/core/hooks/useHossiiStore.tsx`

---

## 概要

参加者がスペースへ投稿（Hossii）を置く画面。
テキスト・感情・吹き出し色・ハッシュタグ・画像を組み合わせて投稿できる。
すべての要素は任意で、いずれか1つ以上があれば投稿可能。

---

## 実装ステータス

| 機能 | 仕様 ID | 状態 |
|---|---|---|
| テキスト入力（200文字） | - | ✅ 実装済み |
| 感情ボタン（クイック選択） | - | ✅ 実装済み |
| 吹き出し色選択（F01） | F01 | ✅ 実装済み |
| ハッシュタグ付与（F09） | F09 | ✅ 実装済み |
| 画像投稿（F10） | F10 | ✅ 実装済み |
| お絵描き投稿（F08） | F08 | **未実装** |

---

## 投稿フォームの構成

```
┌──────────────────────────────────────┐
│  [Hossii キャラ + セリフ]（任意表示） │
│                                      │
│  メッセージ入力エリア（200文字以内）  │
│                                      │
│  感情ボタン（クイック選択）           │
│  😊 😮 💡 🤔 😂 🎉 🥹 ✨           │
│                                      │
│  吹き出し色パレット（8色 + デフォルト）│
│                                      │
│  # ハッシュタグ入力                   │
│                                      │
│  📸 写真を添付                        │
│                                      │
│  [    気持ちを置く    ]               │
└──────────────────────────────────────┘
```

---

## 投稿バリデーション

| 条件 | 動作 |
|---|---|
| 感情・メッセージ・画像がすべて空 | エラートースト表示、送信しない |
| いずれか1つ以上あり | 送信可能 |
| 画像のみ（メッセージ・感情なし） | ✅ 送信可能（F10 実装後） |

---

## F01 吹き出し色選択

**概要**: 投稿時に吹き出しの色をプリセットから選択できる。

**プリセット色（8色）**:
`#FF6B6B` / `#4ECDC4` / `#45B7D1` / `#96CEB4` / `#FFEAA7` / `#DDA0DD` / `#98D8C8` / `#F7DC6F`

**仕様**:
- 未選択時はデフォルト色（グラデーション）
- 選択色は投稿フォームのプレビューには反映しない（スペース画面のバブルに反映）
- 送信後にリセット

**データ**: `hossiis.bubble_color` varchar(7)（例: `"#FF6B6B"`）

---

## F09 ハッシュタグ付与

**概要**: 投稿にハッシュタグを付けてフィルタ・検索に活用する。

**UI 操作**:
- `#` プレフィックス付き入力欄に文字を入力し、Enter / スペース / フォーカス外れでタグを確定
- 確定済みタグはチップ（pill）形式で表示 + `×` で個別削除
- メッセージ本文に `#タグ` を書いた場合も自動抽出してマージ

**バリデーション**: 各タグ最大30文字

**データ**: `hossiis.hashtags` text[]（例: `["朝会", "チーム"]`）

---

## F10 画像投稿

**概要**: 画像（写真）を単体またはテキストと組み合わせて投稿できる。

**UI 操作**:
1. 📸 アイコンのアップロードエリアをタップ / クリック → ファイル選択
2. プレビュー表示（アップロード前のローカルプレビュー）
3. `×` ボタンで添付を取り消し可能
4. 「気持ちを置く」ボタンで送信 → Supabase Storage にアップロード

**アップロード処理**:
- クライアント側圧縮: 最大 1MB・最大 1280px（`imageStorageApi.ts` の `compressImage()`）
- Storage パス: `hossii-images/{spaceId}/{hossiiId}.jpg`
- アップロード成功 → `imageUrl` を hossii に付与して送信
- アップロード失敗（画像のみ投稿）→ エラートーストを表示して送信を中断
- アップロード失敗（テキスト付き投稿）→ 警告トーストを表示してテキストのみ送信

**スペース画面での表示**:
- `viewMode = 'full'` 時: バブル内の下部に画像を表示（最大 200px × 150px）
- `viewMode = 'bubble'` 時: 画像は非表示（バブル形のみ表示）
- `viewMode = 'image'` 時: 画像のみ表示（テキスト・感情アイコン非表示）

**Supabase Storage 設定**:
| 項目 | 値 |
|---|---|
| バケット名 | `hossii-images` |
| 公開設定 | Public |
| INSERT ポリシー | `WITH CHECK (true)` TO public |

**データ**: `hossiis.image_url` text（Supabase Storage の公開 URL）

---

## F08 お絵描き投稿（未実装）

**概要**: キャンバスに指/ペンで描いた絵を PNG として投稿する。

**実装方針**:
- `<canvas>` 要素（モーダル内）
- ツールバー: ペン色・太さ・消しゴム・undo・クリア・送信
- `canvas.toBlob('image/png')` → F10 の画像投稿フローで Storage へアップロード
- スマホ: `touchstart / touchmove / touchend` を優先。`touch-action: none` でスクロール抑制

---

## 送信後の動作

1. 楽観的更新（即時 UI 反映）でスペース画面のバブルに追加
2. Supabase に非同期 INSERT
3. スタンプ +1（ログイン済みユーザーのみ）
4. 成功トースト表示
5. 800ms 後にスペース画面（Home）へ遷移
6. フォームをリセット（選択感情・テキスト・色・タグ・画像をクリア）

---

## スペース設定による制御

スペース管理者は機能ごとに投稿を ON/OFF できる（`SpaceSettingsScreen` > 基本設定）。

| 設定 | 対象 UI |
|---|---|
| `features.commentPost = false` | テキスト入力エリアを非表示 |
| `features.emotionPost = false` | 感情ボタンを非表示 |
| `features.photoPost = false` | 写真添付エリアを非表示 |
| すべて false | 「投稿機能が無効」の警告を表示 |
