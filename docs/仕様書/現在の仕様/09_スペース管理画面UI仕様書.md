# スペース管理画面 UI 仕様書

> 最終更新: 2026-02-27
> 関連ファイル:
> `src/components/SpacesScreen/SpacesScreen.tsx`
> `src/components/SpaceSettingsScreen/SpaceSettingsScreen.tsx`
> `src/components/SpaceSettingsScreen/HossiiCustomTab.tsx`
> `src/core/types/space.ts`

---

## 概要

管理者が操作する画面は 2 層に分かれる。

| 画面 | ルート | 役割 |
|---|---|---|
| スペース管理一覧（`SpacesScreen`） | `/admin/spaces` | スペースの作成・一覧・基本操作 |
| スペース設定（`SpaceSettingsScreen`） | 管理者のみアクセス（現状は `#settings`） | スペースごとの詳細設定 |

認証・コミュニティ登録・ログインフローは **`05_管理者ログイン画面.md`** を参照。

---

## A04 スペース管理一覧画面（`SpacesScreen`）

> **実装ステータス**: ほぼ実装済み（`SpacesScreen.tsx`）。未実装項目は末尾に記載。

### 概要

管理者がコミュニティ配下のスペースを一覧・作成・編集・削除する画面。PC 利用前提。

### 実装ステータス

| 機能 | 状態 |
|---|---|
| スペースカードグリッド（4列・レスポンシブ） | ✅ 実装済み |
| スペース名インライン編集 | ✅ 実装済み |
| スペース ID（spaceURL）インライン編集 | ✅ 実装済み |
| 背景サムネイル・背景変更 | ✅ 実装済み |
| 招待 URL コピー | ✅ 実装済み |
| スペース削除（確認ダイアログ） | ✅ 実装済み |
| スペース作成モーダル | ✅ 実装済み |
| アカウントドロップダウン（ログアウト） | ✅ 実装済み |
| スペース設定画面（詳細編集）へのリンク | **未実装** |
| 投稿数・アクティブ人数などのメトリクス表示 | **未実装**（将来対応） |

### 未実装: スペース設定へのリンク

各スペースカードに「スペースを設定」ボタンを追加し、`SpaceSettingsScreen` へ遷移できるようにする。

```
[スペースカード]
  └── [🔗 招待URL]
  └── [⚙ 設定]   ← 追加
  └── [🗑 削除]
```

- クリック時: `activeSpaceId` を当該スペースの ID に更新してから `SpaceSettingsScreen` へ遷移する

---

## A01 スペース設定：キャラ（Hossii）画像の変更

### 概要

管理者がスペースに表示されるキャラクター画像（透過 PNG）を差し替える機能。

### 対象ページ・コンポーネント

- `SpaceSettingsScreen` > **Hossiiカスタマイズ** タブ（`HossiiCustomTab.tsx`）

### UX フロー

```
管理者
  → SpaceSettingsScreen > Hossiiカスタマイズタブ
  → 「キャラ画像をアップロード」エリアをクリック / ドラッグ&ドロップ
  → プレビュー表示（即時）
  → 「保存」ボタンで確定
  → スペース画面のキャラクターが差し替わる
```

### UI コンポーネント

| 要素 | 説明 |
|---|---|
| アップロードエリア | ドラッグ&ドロップ + クリックでファイル選択 |
| プレビュー | アップロード画像を 120px × 120px でプレビュー（背景チェッカー付き） |
| 削除ボタン | アップロード済み画像を削除してデフォルトに戻す |
| ガイドテキスト | 「透過 PNG 推奨 / 最大 2MB / 推奨解像度 512×512px」 |

### データ仕様

```ts
// space.ts の Space 型に追加
characterImageUrl?: string; // Supabase Storage の公開 URL
```

```sql
ALTER TABLE spaces ADD COLUMN character_image_url text DEFAULT NULL;
```

- Storage パス: `hossii-characters/{spaceId}/character.png`
- 既存画像がある場合は上書き保存

### 制約

| 項目 | 値 |
|---|---|
| ファイル形式 | PNG（透過推奨）、JPG も受け付ける |
| ファイルサイズ上限 | 2MB |
| 推奨解像度 | 512 × 512 px |
| クライアント側リサイズ | 1280px 超の場合は縮小（アスペクト比維持） |

---

## A03 スペース設定：Hossii 表情カスタム

### 概要

キャラクター（Hossii）に登録する表情パターンを管理者がカスタム作成・保存する機能。
作成した表情はスペース上で投稿への反応として使用される。

### 対象ページ・コンポーネント

- `SpaceSettingsScreen` > **Hossiiカスタマイズ** タブ（`HossiiCustomTab.tsx`）

### UX フロー

```
管理者
  → HossiiカスタマイズTab
  → 表情プリセット一覧（デフォルト表情 + カスタム表情）
  → 「+ 表情を追加」ボタン
  → 表情エディタ（イラスト選択 / 画像アップロード）
  → リサイズハンドルでサイズ調整
  → 「保存」で確定 → 一覧に追加
```

### 表情エディタ UI

| 要素 | 説明 |
|---|---|
| プリセット選択 | システム提供の表情イラストから選択 |
| カスタム画像 | 透過 PNG のアップロード（A01 と同じ制約） |
| リサイズハンドル | コーナーハンドルでサイズ調整。最小 40px、最大 200px |
| 表情名入力 | 管理者向けラベル（例: 「驚き」「喜び」）。任意 |
| 保存 / キャンセル | 確定・破棄 |

### データ仕様

```ts
// space.ts に追加
type CustomEmotion = {
  id: string;
  label?: string;       // 管理者向けラベル
  imageUrl: string;     // Storage URL またはプリセット識別子
  width: number;        // px（40〜200）
  height: number;       // px（40〜200）
};

// Space 型に追加
customEmotions?: CustomEmotion[];
```

```sql
ALTER TABLE spaces ADD COLUMN custom_emotions jsonb DEFAULT '[]';
```

### 制約

| 項目 | 値 |
|---|---|
| 最小サイズ | 40 × 40 px |
| 最大サイズ | 200 × 200 px |
| 登録上限 | 20 件 / スペース |
| 画像投稿との整合 | 画像投稿（F10）の `image_url` とは別フィールドで管理 |

---

## A02 スペース装飾（管理者専用配置アイテム）

### 概要

管理者がスペース上に「掲示板」などのウィジェットを自由に配置できる機能。
一般参加者は閲覧のみ可能（移動・削除不可）。

### 対象ページ・コンポーネント

- `SpaceSettingsScreen` に「スペース装飾」タブを新設
- スペース表示画面（`SpaceScreen.tsx`）で装飾を重畳表示

### 装飾タイプ（v1 スコープ）

| タイプ | 説明 |
|---|---|
| `bulletin_board` | 掲示板ウィジェット（タイトル + テキスト本文） |
| （将来）`image` | 静的画像配置 |
| （将来）`link` | URL リンクカード |

### 管理者向け UX（設定画面）

```
スペース装飾タブ
  └── 装飾一覧（カード形式）
        ├── [+ 装飾を追加] ボタン → 種類選択 → 内容入力 → 追加
        ├── 各装飾カード
        │     ├── タイプアイコン + 内容プレビュー
        │     ├── 位置（X / Y）数値入力 or スペース上でドラッグ
        │     └── [✏ 編集] [🗑 削除]
        └── 「保存」で確定
```

### 一般参加者向け表示（`SpaceScreen`）

- 装飾は吹き出しレイヤーの上（z-index で前面）に固定表示
- クリック / タップで内容を展開（掲示板の場合はモーダルまたはポップアップ）
- 編集・移動・削除のコントロールは非表示

### データ仕様

```ts
// space.ts に追加
type SpaceDecoration = {
  id: string;
  type: 'bulletin_board';   // 将来拡張
  position: { x: number; y: number }; // % 単位（0〜100）
  content: {
    title?: string;
    body: string;
  };
  style?: {
    width?: number;     // px
    backgroundColor?: string;
  };
};

// Space 型に追加
decorations?: SpaceDecoration[];
```

```sql
ALTER TABLE spaces ADD COLUMN decorations jsonb DEFAULT '[]';
```

### 権限

| 操作 | 管理者 | 一般参加者 | ゲスト |
|---|---|---|---|
| 追加 / 編集 / 削除 | ✅ | ❌ | ❌ |
| 閲覧 | ✅ | ✅ | ✅ |

---

## A05 モデレーション（投稿の一覧・非表示 / 復元）

### 概要

管理者がスペース内の投稿を一覧確認し、不適切な投稿を非表示にしたり復元したりできる機能。

### 対象ページ・コンポーネント

- `SpaceSettingsScreen` に「モデレーション」タブを新設（またはスタンドアロンページ）

### UX フロー

```
管理者
  → SpaceSettingsScreen > モデレーション タブ
  → 投稿一覧（全件 / 非表示のみ 切り替え）
  → 検索・フィルター（期間 / ハッシュタグ / 投稿者名）
  → 各投稿行に [非表示] または [復元] ボタン
  → 確認ダイアログ → 実行 → 一覧に即時反映
```

### UI コンポーネント

| 要素 | 説明 |
|---|---|
| フィルターバー | 表示中 / 非表示 / 全件 セグメント切り替え |
| 検索フォーム | 投稿者名・キーワード・期間（from〜to） |
| 投稿一覧テーブル | 投稿日時 / 投稿者 / メッセージ（省略）/ 状態 / 操作ボタン |
| 非表示ボタン | 「非表示にする」→ 確認ダイアログ → 実行 |
| 復元ボタン | 「復元する」→ 即時実行（確認なし） |

### データ仕様

```sql
-- 08_スペース（HOME）仕様書の F06 と共通
ALTER TABLE hossiis ADD COLUMN is_hidden boolean DEFAULT false;
ALTER TABLE hossiis ADD COLUMN hidden_at timestamptz DEFAULT NULL;
ALTER TABLE hossiis ADD COLUMN hidden_by text DEFAULT NULL; -- 管理者の user_id
```

```ts
// Hossii 型に追加
isHidden?: boolean;
hiddenAt?: Date;
hiddenBy?: string; // 管理者 userId
```

### スペース表示側の対応

```ts
// SpaceScreen.tsx の displayHossiis フィルタに追加
const displayHossiis = hossiis.filter(
  (h) => !h.isHidden && /* 既存フィルタ */
);
```

### 監査ログ

| 項目 | 内容 |
|---|---|
| 操作種別 | `hide` / `restore` |
| 対象 | `hossii_id` |
| 実行者 | 管理者の `userId` |
| 実行日時 | `timestamptz` |

```sql
CREATE TABLE moderation_logs (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  space_id text NOT NULL,
  hossii_id text NOT NULL,
  action text NOT NULL CHECK (action IN ('hide', 'restore')),
  admin_id text NOT NULL,
  created_at timestamptz DEFAULT now()
);
```

### 権限

| 操作 | 管理者 | 一般参加者 | ゲスト |
|---|---|---|---|
| 投稿一覧閲覧 | ✅（全件） | ❌ | ❌ |
| 非表示 / 復元 | ✅ | ❌ | ❌ |
| 非表示投稿の閲覧 | ❌（スペース上） | ❌ | ❌ |

---

## 実装優先度まとめ

| 優先度 | 機能 ID | 内容 | 依存関係 |
|---|---|---|---|
| 高 | A05 | モデレーション（非表示 / 復元） | `is_hidden` カラム追加（F06 と共通） |
| 高 | A04 補足 | スペースカードに「設定」ボタン追加 | なし |
| 中 | A01 | キャラ画像変更（透過 PNG） | Supabase Storage 設定 |
| 中 | A03 | Hossii 表情カスタム | A01 の Storage 設定が前提 |
| 低 | A02 | スペース装飾（掲示板ウィジェット） | スペース画面の z-index 設計 |
