# ログインユーザー管理設計

> 最終更新: 2026-03-01（フェーズ1・2 実装完了）
> 関連仕様: `05_管理者ログイン画面.md` / `03_スペースURL機能.md`

---

## 目的

現状は誰がログインしても同一のスペース管理画面が表示されるが、
各ログインアカウント（コミュニティ）ごとに **自分のスペース管理画面** へ遷移できるようにする。
スペースデータはコミュニティ単位で完全に分離し、混在しないようにする。

---

## 段階的実装計画（フェーズ）

本設計は一括実装ではなく、リスクの低い順に段階的に実装する。

| フェーズ | 内容 | 優先度 | 状態 |
|---------|------|--------|------|
| **フェーズ 1** | URL バーの修正（入室後も `/s/[slug]` を保持） | 高・低リスク | **✅ 完了** |
| **フェーズ 2** | コミュニティ別スペース分離（`community_id` でフィルタリング） | 高 | **✅ 完了** |
| **フェーズ 3** | URL 構造移行（`/c/[community-id]/s/[space-id]/`） | 中 | **未実装** |
| **フェーズ 4** | アカウント情報画面・プラン管理・slug 編集 | 低・将来対応 | **未実装** |

---

### フェーズ 1 — URL バーの修正

**問題:** 入室時に `window.history.replaceState` で `/#screen` に書き換えているため、URL をコピーしても別のスペースが開く。

**変更箇所:** `src/App.tsx` の `replaceState` 呼び出し 2 箇所

```
変更前: replaceState({}, '', '/#screen')
変更後: replaceState({}, '', `/s/${spaceURL}`)
```

---

### フェーズ 2 — コミュニティ別スペース分離

**問題:** 現状は全管理者が全スペースを見てしまう（`community_id` によるフィルタがない）。

**変更箇所:**

| 対象 | 変更内容 |
|------|---------|
| `src/core/utils/spacesApi.ts` | `fetchSpaces(communityId)` に `community_id` フィルタを追加 |
| `src/core/utils/spacesApi.ts` | スペース作成時に `community_id` を INSERT |
| `src/core/hooks/useHossiiStore.tsx` | `AuthContext` から `communityId` を受け取り `fetchSpaces` に渡す |
| Supabase Dashboard（SQL） | `spaces` テーブルの RLS: 自コミュニティのみ操作可 |

---

### フェーズ 3 — URL 構造移行

**フェーズ 2 完了後に着手。**

**変更箇所:**

| 対象 | 変更内容 |
|------|---------|
| `src/App.tsx` | パスマッチを `/c/:communityId/s/:spaceId` に更新 |
| `src/components/SpacesScreen/SpacesScreen.tsx` | 招待 URL を新フォーマットで生成 |
| `src/components/SpaceSettingsScreen/ShareTab.tsx` | URL プレフィックスを更新 |
| `src/components/Navigation/QRCodePanel.tsx` | QR 用 URL 生成を更新 |

---

### フェーズ 4 — 将来対応

- コミュニティ slug のインライン編集 UI
- space-id のインライン編集 UI（URL 変更）
- アカウント情報画面（コミュニティ名・スペース一覧・プラン表示）
- 旧 URL（`/s/[slug]`）へのアクセス時のリダイレクト
- 有料プラン・スペース数上限チェック

---

## コミュニティとアカウントの概念整理

| 概念 | 説明 |
|------|------|
| **コミュニティ** | スペースを所有・管理する上位エンティティ。管理者 1 アカウント = 1 コミュニティ |
| **スペース** | コミュニティ配下に作成される投稿空間。複数持てる |
| **管理者アカウント** | コミュニティを登録したユーザー。`app_metadata.role === "admin"` |

---

## URL 設計

スペースの URL は **コミュニティ ID とスペース ID の 2 階層** で構成する。

```
/c/[community-id]/s/[space-id]/
```

| セグメント | 説明 | 編集 | バリデーション |
|-----------|------|------|--------------|
| `community-id` | コミュニティのスラッグ（例: `hossii-team`） | 管理画面から編集可 | 英小文字・数字・ハイフン、3〜40文字、先頭末尾ハイフン不可 |
| `space-id` | スペースのスラッグ（例: `abc123`） | 管理画面から編集可 | 英小文字・数字・ハイフン、3〜40文字、先頭末尾ハイフン不可 |

> `05_管理者ログイン画面.md` に記載の `/s/[slug]` は本設計の `/c/[community-id]/s/[space-id]/` に置き換える。

### URL 変更例

| 変更前 | 変更後 |
|--------|--------|
| `/s/abc123` | `/c/hossii-team/s/abc123` |

---

## ログイン〜スペース管理画面の遷移

### 現状（問題）

- 全管理者が共通のスペース管理画面に遷移してしまう
- スペースのデータが混在する可能性がある

### 目標

ログインしたアカウントに紐づく **自分のコミュニティのスペース一覧のみ** が表示される。
`communities` テーブルの `owner_id`（Supabase Auth の `user.id`）でフィルタリングする。

```
/admin/login → ログイン成功
  │
  └─ app_metadata.role === "admin"
       │
       └─ SpacesScreen（自分のコミュニティのスペース一覧のみ表示）
```

---

## 既存アカウントの紐付け

現在のスペース管理画面（既存データ）は以下のアカウントに紐づける。

| 項目 | 値 |
|------|-----|
| メールアドレス | `Hossiitest@gmail.com` |
| パスワード | `Hossiitest` |

このアカウントを Supabase の `communities` テーブルに登録し、`app_metadata.role = "admin"` を付与することで、既存スペースデータをそのまま引き継ぐ。

---

## データベース設計方針

### スペースのデータ分離

- スペースのデータは `community_id` + `space-id`（スラッグ）単位で保存する
- 異なるコミュニティのスペースデータは **完全に分離** する
- Supabase の Row Level Security（RLS）により、自分のスペースデータのみ読み書きできる

| テーブル | 分離キー | RLS ポリシー |
|---------|---------|-------------|
| `communities` | `owner_id` | `owner_id = auth.uid` のもののみ SELECT/UPDATE |
| `spaces` | `community_id` | 自コミュニティのスペースのみ SELECT/INSERT/UPDATE/DELETE |
| `posts` | `space_id` | スペースに属するデータのみアクセス可 |

### `communities` テーブル（主要カラム）

| カラム | 型 | 説明 |
|-------|-----|------|
| `id` | uuid | 主キー |
| `owner_id` | uuid | Supabase Auth の `user.id` |
| `name` | text | コミュニティ名（表示用） |
| `slug` | text | URL 用スラッグ（`community-id`）。ユニーク |
| `plan` | text | `"free"` / `"standard"` / `"enterprise"` |
| `created_at` | timestamp | 作成日時 |

---

## アカウント情報画面（管理者）

管理者のアカウント情報画面に以下を表示する。

| 表示項目 | 説明 |
|---------|------|
| コミュニティ名 | 登録時に設定したコミュニティ名 |
| メールアドレス | ログインに使用しているメールアドレス |
| 運用中スペース一覧 | 自分のコミュニティ配下のスペース名・URL・ステータス |
| プラン | Free / （将来）有料プラン |
| ログアウト | ログアウトボタン |

---

## コミュニティ登録フロー（申請→審査→承認制）

コミュニティの利用は **Hossii 運営による審査・承認制** とする。
登録申請後に即座にスペース管理画面が使えるわけではない。

### 申請フロー

```
コミュニティ名 + メールアドレス + パスワード を入力 →「登録申請する」
  │
  └─ Supabase Auth でユーザー作成
       │
       └─ `communities` テーブルにレコード挿入（status = 'pending'）
            │
            └─「申請を受け付けました」画面を表示（審査中）
```

### 承認フロー（Hossii 運営操作）

Supabase ダッシュボードの SQL Editor で実行：

```sql
-- 承認
UPDATE communities SET status = 'approved' WHERE name = 'コミュニティ名';
UPDATE auth.users
  SET raw_app_meta_data = raw_app_meta_data || '{"role":"admin"}'::jsonb
  WHERE id = (SELECT admin_id FROM communities WHERE name = 'コミュニティ名');

-- 却下
UPDATE communities SET status = 'rejected' WHERE name = 'コミュニティ名';
```

### ログイン時の状態別ふるまい

| `communities.status` | ふるまい |
|----------------------|---------|
| `pending` | 「審査中です」画面を表示。SpacesScreen には入れない |
| `approved` | SpacesScreen（スペース管理画面）へ遷移 |
| `rejected` | 「申請が承認されませんでした」画面を表示。自動ログアウト |
| コミュニティ未登録 | エラーメッセージを表示。自動ログアウト |

### `app_metadata.role = "admin"` による判定

- Supabase Dashboard で手動付与した場合も `isAdmin: true` として扱う（`communities.status` のチェックをスキップ）
- 承認 SQL では Auth のメタデータ付与と `status = 'approved'` の両方を実行すること

---

## プラン設計（将来対応）

現時点では全アカウントを **Free プラン** として扱う。
将来的に有料プランを導入する際のための設計方針。

| プラン | コミュニティ登録 | スペース作成数 | 備考 |
|--------|--------------|-------------|------|
| Free | ○ | 1個まで（暫定） | 現在はテスト段階のため制限なし |
| Standard（将来） | ○ | 複数 | 月額課金 |
| Enterprise（将来） | ○ | 無制限 | 年間契約等 |

- `communities` テーブルの `plan` カラムで管理（`"free"` / `"standard"` / `"enterprise"`）
- スペース作成時に `plan` に応じた上限チェックを行う（現在は未実装）
- 課金機能（Stripe 等）は将来フェーズで実装

---

## ログアウト設計

### 問題点と対処

以下の 3 つの問題が確認されており、対処済み。

| 問題 | 内容 | 対処 |
|------|------|------|
| エラー時にリダイレクトされない | `logout()` がエラーを throw すると `window.location.href` に到達しない | `handleLogout` に try/catch を追加。エラーが起きてもリダイレクトを実行する |
| セッションが残る | `signOut()` のデフォルト（`scope: 'global'`）がネットワークエラー等で失敗すると、セッションが残り再ログイン状態になる | `scope: 'local'` に変更。ローカルセッションを確実に削除する |
| `/admin/login` が 404 になる | Vite の SPA フォールバックが未設定のため、本番・プレビュー環境で `/admin/login` に直接アクセスすると 404 になる | `vite.config.ts` に `historyApiFallback: true` を追加 |

### ログアウトフロー

```
ログアウトボタンをクリック
  │
  └─ try { await logout() } catch { console.error } // エラーでも続行
       │
       └─ supabase.auth.signOut({ scope: 'local' }) // ローカルセッションを削除
            │
            └─ window.location.href = '/admin/login' // 必ずリダイレクト
                 │
                 └─ AdminLoginScreen を表示
```

### 対象ファイル

| ファイル | 変更内容 |
|---------|---------|
| `src/components/SpacesScreen/SpacesScreen.tsx` | `handleLogout` に try/catch を追加 |
| `src/core/contexts/AuthContext.tsx` | `signOut` を `scope: 'local'` に変更 |
| `vite.config.ts` | `server.historyApiFallback` / `preview.historyApiFallback` を `true` に設定 |

---

## 実装ステータス

### 完了済み

| 機能 | 対象ファイル |
|------|------------|
| ✅ ログアウト（エラー時リダイレクト） | `SpacesScreen.tsx` |
| ✅ ログアウト（ローカルセッション確実削除） | `AuthContext.tsx` |
| ✅ SPA フォールバック（`/admin/login` の 404 対策） | `vite.config.ts` |
| ✅ 登録申請→審査中画面の表示 | `AdminLoginScreen.tsx` |
| ✅ `communities.status` による承認制フロー | `AuthContext.tsx` |
| ✅ ログイン時の pending/rejected 状態ハンドリング | `App.tsx` |

### フェーズ 1（未実装）

| 機能 | 対象ファイル |
|------|------------|
| 入室後も `/s/[slug]` を URL バーに保持 | `src/App.tsx` |

### フェーズ 2（未実装）

| 機能 | 対象ファイル |
|------|------------|
| `community_id` によるスペース取得フィルタリング | `src/core/utils/spacesApi.ts` |
| スペース作成時に `community_id` を付与 | `src/core/utils/spacesApi.ts` |
| `communityId` を `useHossiiStore` に渡す | `src/core/hooks/useHossiiStore.tsx` |
| Supabase RLS: `spaces` テーブルのデータ分離 | Supabase Dashboard（SQL） |

### フェーズ 3（未実装、フェーズ2完了後）

| 機能 | 対象ファイル |
|------|------------|
| `/c/[community-id]/s/[space-id]/` URL パターンへの対応 | `src/App.tsx` |
| 招待 URL・QR コード用 URL の新フォーマット化 | `SpacesScreen.tsx` / `ShareTab.tsx` / `QRCodePanel.tsx` |

### フェーズ 4（将来対応）

| 機能 | 状態 |
|------|------|
| community-id・space-id のインライン編集 | 未実装 |
| アカウント情報画面（コミュニティ名・スペース一覧） | 未実装 |
| 旧 URL（`/s/[slug]`）のリダイレクト対応 | 未実装 |
| プランカラムの追加・スペース数上限チェック | 未実装（現在 Free 固定） |
