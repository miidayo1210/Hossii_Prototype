# 画像投稿仕様書（F10）

> 最終更新: 2026-03-01
> 関連ファイル:
> `src/core/utils/imageStorageApi.ts`
> `src/components/PostScreen/PostScreen.tsx`
> `src/components/PostScreen/PostScreen.module.css`
> `src/core/hooks/useHossiiStore.tsx`

---

## 概要

投稿（Hossii）に画像（写真・お絵描きキャプチャ）を添付する機能。
**アプリを軽く保つこと**を最優先とし、クライアント側で自動圧縮したうえで Supabase Storage にアップロードする。
スペース画面での表示時は、選択・展開されたものだけ画像を読み込む（遅延読み込み）ことで、特にモバイル（iPhone）での通信量・メモリ使用を抑える。

---

## 設計方針

| 方針 | 詳細 |
|---|---|
| クライアント圧縮必須 | アップロード前に必ずローカルで圧縮。サーバー側では無加工で保存 |
| 最大サイズ制限 | 圧縮後 1MB 以下・長辺 1280px 以下 |
| 遅延読み込み | スペース画面では画像を一括ロードせず、ユーザーが選択したバブルのみ表示 |
| フォールバック | アップロード失敗時もテキスト投稿は継続（画像単体投稿のみ中断） |

---

## クライアント側圧縮（`compressImage`）

実装: `src/core/utils/imageStorageApi.ts`

### 圧縮アルゴリズム

```
1. File → ObjectURL → <img> で読み込み
2. 長辺が 1280px 超 → アスペクト比を保ちながら 1280px にリサイズ
3. Canvas に描画 → `toBlob('image/jpeg', quality)` でエンコード
4. blob.size > 1MB かつ quality > 0.4 → quality を 0.1 ずつ下げてリトライ
5. 1MB 以下になった時点 or quality=0.4 に到達した時点で確定
```

### パラメータ一覧

| パラメータ | 値 | 備考 |
|---|---|---|
| `MAX_SIZE_BYTES` | 1,048,576 (1MB) | 圧縮後の上限 |
| `MAX_DIMENSION` | 1,280px | 長辺の上限 |
| 初期 quality | 0.85 | JPEG 品質（0.0〜1.0） |
| 最低 quality | 0.40 | これ以下には下げない |
| quality 刻み | 0.10 | 1ステップの低下幅 |
| 出力フォーマット | `image/jpeg` | PNG・HEIC もすべて JPEG 変換 |

### 圧縮失敗時のフォールバック

`compressImage()` が reject した場合、元の `File` をそのままアップロードする（圧縮スキップ）。

---

## アップロードフロー

```
[ユーザーが画像を選択]
      ↓
[ローカルプレビュー表示（ObjectURL）]
      ↓
[「気持ちを置く」送信]
      ↓
compressImage(file)
      ↓
supabase.storage.upload(path, blob)
  ├─ 成功 → getPublicUrl() → imageUrl を hossii に付与 → INSERT
  └─ 失敗
       ├─ 画像のみ投稿 → エラートースト表示・送信中断
       └─ テキスト付き投稿 → 警告トースト表示・テキストのみ送信
```

### Storage パス規則

```
hossii-images/{spaceId}/{hossiiId}.jpg
```

---

## Supabase Storage 設定

| 項目 | 値 |
|---|---|
| バケット名 | `hossii-images` |
| 公開設定 | Public |
| INSERT ポリシー | `WITH CHECK (true)` TO public |

---

## 投稿フォーム UI

### 写真添付エリア

- 📸 アイコンのアップロードエリアをタップ / クリック → OS ファイル選択ダイアログ
- 選択後、ローカルプレビューを表示（アップロードはまだ行わない）
- `×` ボタンで添付を取り消し可能（送信前のみ）
- `✏️ お絵描き` ボタンも同エリアに配置（DrawingModal を開く）

### バリデーション

| 条件 | 動作 |
|---|---|
| 画像のみ（テキスト・感情なし） | ✅ 送信可能 |
| 画像 + テキスト or 感情 | ✅ 送信可能 |
| 画像なし・テキスト・感情すべて空 | エラートースト表示・送信不可 |

---

## スペース画面での表示（遅延読み込み）

### 設計目的

iPhone などモバイル端末でスペースに大量のバブルが表示されても、画像を全件一括ロードしない。
選択・展開されたバブルだけ `<img>` を描画することで、通信量・メモリ・描画コストを抑える。

### viewMode 別の表示ルール

| viewMode | 画像表示 | 条件 |
|---|---|---|
| `bubble` | 非表示 | バブル形状のみ表示。画像 URL があっても `<img>` は描画しない |
| `full` | 表示 | バブル内下部に表示。最大 200px × 150px、`object-fit: cover` |
| `image` | 表示（画像のみ） | テキスト・感情アイコンを非表示にして画像を前面に出す |

### 遅延読み込みの実装方針

- `viewMode = 'bubble'` 時は `<img>` タグを DOM に挿入しない（`src` を空にするのではなく要素自体を非マウント）
- `viewMode = 'full'` / `'image'` に切り替わった時点で初めて `<img src={imageUrl}>` を描画
- `loading="lazy"` 属性を付与し、ビューポート外の画像はブラウザレベルで遅延ロード

### iPhone 向けの追加考慮

- 全バブルを一度に `full` 展開しない（デフォルト `viewMode` は `bubble`）
- ユーザーが個別バブルをタップしたときだけそのバブルを `full` 展開する
- スクロール中は画像ロードが不要なバブルの `<img>` を再 mount しない（キー変更による不要な再描画を避ける）

---

## データ型

`Hossii` 型への追加フィールド:

```ts
type Hossii = {
  // ...既存フィールド...
  imageUrl?: string;  // Supabase Storage の公開 URL
};
```

DB カラム: `hossiis.image_url text`（NULL 許容）

---

## 実装済みステータス

| 項目 | 状態 |
|---|---|
| `compressImage()`（クライアント圧縮） | ✅ 実装済み |
| `uploadHossiiImage()`（Storage アップロード） | ✅ 実装済み |
| 投稿フォームのプレビュー表示・取り消し | ✅ 実装済み |
| アップロード失敗時のフォールバック | ✅ 実装済み |
| スペース画面の viewMode 別表示制御 | ✅ 実装済み |
| `loading="lazy"` による遅延読み込み | 未実装（要対応） |
| バブルモードで `<img>` を非マウント | 未実装（要対応） |
| 個別バブルタップで展開（モバイル最適化） | 未実装（要対応） |

---

## 今後の対応タスク

1. **遅延読み込み対応**: `Bubble` コンポーネントで `viewMode !== 'bubble'` のときのみ `<img>` をマウントし、`loading="lazy"` を付与する
2. **モバイル最適化**: デフォルト `viewMode` を `bubble` に保ち、バブルをタップしたときだけそのバブルを `full` モードで展開するインタラクションを実装する
3. **サムネイル生成（将来）**: アップロード時に小サイズ（例: 200px）のサムネイル URL も保存し、一覧表示にはサムネイルを使う
