# ゲスト入室フロー 仕様

> 最終更新: 2026-03-01
> 関連ファイル:
> `src/App.tsx`
> `src/components/Auth/GuestEntryScreen.tsx`
> `src/components/Auth/GuestEntryScreen.module.css`
> `src/core/utils/profileStorage.ts`
> `src/core/hooks/useHossiiStore.tsx`

---

## 概要

`/s/[slug]` のスペース URL に未ログイン状態でアクセスした場合のゲスト入室フロー。
ニックネームを **localStorage に保存** し、2回目以降のアクセスでは入力画面をスキップして直接スペースへ入室する。

---

## 入室フロー

### 初回アクセス（ニックネーム未保存）

```
/s/[slug] にアクセス
  │
  ├─ ログイン済み → ニックネーム未設定なら NicknameModal → SpaceScreen
  │
  └─ 未ログイン
        │
        ↓
  GuestEntryScreen（ゲスト入室画面）
        │
        ├─「ゲストとして参加」→ ニックネーム入力 → スペースへ入室
        │                         ↑ ニックネームを localStorage に保存
        └─「アカウントでログイン」→ StartScreen（ログイン画面）
```

### 2回目以降のアクセス（ニックネーム保存済み）

```
/s/[slug] にアクセス
  │
  └─ 未ログイン
        │
        ↓ hasNicknameForSpace(spaceId) === true を確認
        │
        → GuestEntryScreen をスキップ
        → isGuestMode = true でそのまま SpaceScreen へ
```

---

## ローカル保存仕様

| 項目 | localStorage キー | 型 |
|------|------------------|----|
| スペース固有ニックネーム | `hossii.spaceNicknames` | `{ [spaceId: string]: string }` |
| デフォルトニックネーム | `hossii.profile.defaultNickname` | `string` |

### ニックネームの優先順位

投稿・表示名の解決順：
1. `hossii.spaceNicknames[activeSpaceId]`（スペース固有）
2. `hossii.profile.defaultNickname`（デフォルト）
3. 空文字（未設定）

---

## GuestEntryScreen の動作

| 状況 | ニックネーム入力欄の初期値 |
|------|--------------------------|
| 初回（何も保存なし） | 空文字 |
| スペース固有ニックネームあり | そのニックネーム（先詰め） |
| デフォルトニックネームのみあり | デフォルトニックネーム（先詰め） |

---

## isGuestMode フラグ

`App.tsx` 内でセッション中のみ保持するローカル state（リロードでリセット）。

| 状態 | 意味 |
|------|------|
| `false` + ニックネーム未保存 | GuestEntryScreen を表示 |
| `false` + ニックネーム保存済み | GuestEntryScreen をスキップして SpaceScreen へ |
| `true` | すでに入室済み（GuestEntryScreen を表示しない） |

> ゲストモードはページをリロードしても **ニックネームが localStorage に残っていれば** 自動的に復元される。
> localStorage を消去すると次回アクセス時に再度 GuestEntryScreen が表示される。

---

## 関連する状態管理

```ts
// useHossiiStore (App.tsx で参照)
hasNicknameForSpace(spaceId: string): boolean
// → state.spaceNicknames[spaceId] が存在するかどうか

setSpaceNickname(spaceId: string, nickname: string): void
// → state.spaceNicknames を更新し localStorage に保存
```

---

## GuestEntryScreen デザイン仕様

### 背景

| 項目 | 値 |
|------|----|
| 背景グラデーション | `linear-gradient(150deg, #ede9fe 0%, #f5f3ff 40%, #fce7f3 100%)` |
| 装飾 | CSS のみのグローブロブ（`.blob1〜3`）を3つ配置。`blur(60px)` のぼんやりした光 |
| アニメーション | **なし**（旧デザインの動く星エフェクトは廃止） |

> 旧デザインは 1〜5px の極小 PNG をタイル状にリピートしアニメーションで動かしていた。
> ピクセルの粗さと動きによる視覚的ストレスを解消するため、CSS グラデーションのみに変更。

### グローブロブ（装飾）

| クラス | 位置 | 色 |
|--------|------|----|
| `.blob1` | 右上 | 薄紫（`rgba(167, 139, 250, 0.35)`） |
| `.blob2` | 左下 | 薄ピンク（`rgba(236, 72, 153, 0.2)`） |
| `.blob3` | 中央 | 薄インディゴ（`rgba(99, 102, 241, 0.18)`） |

### カード

| 項目 | 値 |
|------|----|
| 背景 | `rgba(255, 255, 255, 0.82)` + `backdrop-filter: blur(24px)` |
| 枠線 | `1px solid rgba(255, 255, 255, 0.9)` |
| 角丸 | `24px` |
| 最大幅 | `360px` |
| 影 | 薄紫系のソフトシャドウ 2層 |

### テキスト色

| 要素 | 色 |
|------|----|
| ロゴ（`.logo`） | `#4c1d95`（ディープパープル） |
| スペース名（`.spaceName`） | `#6b7280`（グレー） |
| 注釈（`.guestNote`, `.loginNote`） | `#9ca3af`（ライトグレー） |

### ボタン

| ボタン | スタイル |
|--------|---------|
| 「ゲストとして参加」（primary） | 紫グラデーション、ホバーで影が強くなり `translateY(-1px)` で浮き上がる |
| 「アカウントでログイン」（secondary） | 白背景・グレー枠線、ホバーで薄紫色に変化 |
| 「戻る」 | テキストリンク風、アンダーライン付き |

### 入力欄

| 状態 | スタイル |
|------|---------|
| 通常 | 白背景・グレー枠線（`#e5e7eb`） |
| フォーカス | 紫枠線（`#a78bfa`）＋薄紫グロー（`box-shadow`） |
| プレースホルダー | `#d1d5db`（薄いグレー） |

---

## 現状の制約

| 制約 | 内容 |
|------|------|
| ニックネームの変更 | 現状、入室後にスペース固有ニックネームを変更する UI なし（Profile 画面からデフォルトは変更可） |
| ブラウザをまたいだ継続 | localStorage はブラウザ固有のため、別ブラウザ・シークレットモードでは初回と同じ扱い |
| ゲストモードの永続性 | `isGuestMode` フラグはメモリ上のみ。ページリロード後はニックネームの有無で自動判定 |
